# --- Libbook Datasource ---
spring.datasource.libbook.url=jdbc:mysql://localhost:3306/libbook?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC&allowMultiQueries=true
spring.datasource.libbook.username=root
spring.datasource.libbook.password=Mysql
spring.datasource.libbook.driver-class-name=com.mysql.cj.jdbc.Driver

# --- Libdemo Datasource ---
spring.datasource.libdemo.url=jdbc:mysql://localhost:3306/libdemo?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC&allowMultiQueries=true
spring.datasource.libdemo.username=root
spring.datasource.libdemo.password=Mysql
spring.datasource.libdemo.driver-class-name=com.mysql.cj.jdbc.Driver

# --- Global JPA / Hibernate Settings ---
# This ensures Hibernate doesn't try to create its own 'id' columns
spring.jpa.hibernate.ddl-auto=none
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true

# CRITICAL: This forces Hibernate to use the EXACT names in your @Column annotations
# Without this, Hibernate might ignore "event_id" and look for "id"
spring.jpa.hibernate.naming.physical-strategy=org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
spring.jpa.hibernate.naming.implicit-strategy=org.hibernate.boot.model.naming.ImplicitNamingStrategyLegacyJpaImpl

# Dialect
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL8Dialect

# --- Logging ---
logging.level.org.hibernate.SQL=DEBUG
logging.level.org.hibernate.orm.jdbc.bind=trace
# This will show you exactly why a connection might be failing
logging.level.com.zaxxer.hikari=DEBUG

logging.level.org.springframework.web=DEBUG 
logging.level.org.hibernate.tool.schema=DEBUG

<<<<<<<<<

Complete Active Schedule Implementation Package
Generated from conversation and analysis Date: January 24, 2026

Table of Contents
Original Requirements
System Understanding
Step-by-Step Analysis
Sequence Diagrams
Activity Diagrams
API Specifications
Database Schema
JSON Payloads
Implementation Guide
Deployment and Monitoring
Original Requirements
Active Schedule Flow – Description
Key Definitions:

TSP (Train Scheduled Plan Departure Time): Base scheduled departure time
PlannedTime: Estimated/Published departure time (PUB_TRN_ETD = EST_DPT_TS)
Train Eligible: Train types starting with A, B, C, E, G, M, Q, S, U, X, Z and TSP ≠ 00:01
TrainLDOState: Indicates whether the train is LATE or NOT_LATE
When a Train Becomes Part of Active Schedule:

A train is included in the Active Schedule when any of the following is true:

Current time is past the base schedule time (TSP)
Planned Departure Time is later than TSP
Crew is not called within the required advance window (default: 4 hours before TSP)
Even if a train is currently not late, it will still appear in Active Schedule if the crew is not called on time.

Active Schedule Processing Logic:

Action Code = DELETE

If: Train is eligible, TSP > 00:01, Action code = delete
Then: Set TrainLDOState = null, No Late/Not-Late processing occurs
PlannedTime ≤ TSP (Train On Time or Early)

If: Train is eligible, PlannedTime ≤ TSP, TrainLDOState is LATE or null, TSP exists and is in the future
Then: Set a timer to TSP
Update: TrainLDOState = NOT_LATE, synUpdateTrainLDO(NOT_LATE), synASC(TSP, PlannedTime, NOT_LATE)
PlannedTime > TSP (Train Late)

If: Train is eligible, PlannedTime > TSP, TSP exists, TSP changed to a past time OR current time already crossed TSP
Then: Update: TrainLDOState = LATE, synUpdateTrainLDO(LATE), synASC(TSP, PlannedTime, LATE)
TSP Changed (Including from NULL)

a) TSP changed to a future time: If PlannedTime ≤ TSP and TrainLDOState is NOT_LATE, then reset timer to new TSP, keep train NOT_LATE
b) TSP changed to a past time: If PlannedTime > TSP, then mark train as LATE
When TSP Timer Fires

If: Train is eligible, TrainLDOState = NOT_LATE, Train state = SCHEDULED
Then: Transition train to LATE
Trigger: synUpdateTrainLDO(LATE), synASC(LATE), synASN(LATE)
System Understanding
Core Concepts:

TSP: The original scheduled departure time for a train
PlannedTime: The current estimated departure time (may differ from TSP)
Train Eligible: Only certain train types (A, B, C, E, G, M, Q, S, U, X, Z) with valid TSP times
TrainLDOState: Current lateness status (LATE, NOT_LATE, or null)
When Trains Enter Active Schedule: A train becomes actively monitored when:

Current time passes the original TSP
PlannedTime exceeds TSP (train is running late)
Crew isn't called 4 hours before TSP (operational issue)
Step-by-Step Analysis
Step 1: DELETE Action
If train gets a DELETE action code, clear TrainLDOState to null
No further late/not-late processing occurs
Step 2: Train On Time/Early (PlannedTime ≤ TSP)
If train is eligible and PlannedTime ≤ TSP
Set timer to fire at TSP time
Mark train as NOT_LATE
Update systems with NOT_LATE status
Step 3: Train Late (PlannedTime > TSP)
If PlannedTime exceeds TSP and TSP is in the past
Immediately mark train as LATE
Update systems with LATE status
Step 4: TSP Changes
Future TSP: Reset timer, keep NOT_LATE status
Past TSP: If PlannedTime > TSP, mark as LATE immediately
Step 5: Timer Expiration
When TSP timer fires and train hasn't departed
Automatically transition from NOT_LATE to LATE
Trigger all late notification systems
Sequence Diagrams
Mermaid Sequence Diagram Script
sequenceDiagram
    participant System as Active Schedule System
    participant Timer as Timer Service
    participant LDO as Train LDO Service
    participant ASC as ASC Service
    participant ASN as ASN Service

    Note over System: Train becomes eligible for Active Schedule

    alt Action Code = DELETE
        System->>LDO: Set TrainLDOState = null
        Note over System: No further processing

    else PlannedTime <= TSP (On Time or Early)
        System->>Timer: Set timer to TSP
        System->>System: Set TrainLDOState = NOT_LATE
        System->>LDO: synUpdateTrainLDO(NOT_LATE)
        System->>ASC: synASC(TSP, PlannedTime, NOT_LATE)

        Note over Timer: Timer waits until TSP
        Timer->>System: Timer fires at TSP

        alt Train still SCHEDULED and NOT_LATE
            System->>System: Set TrainLDOState = LATE
            System->>LDO: synUpdateTrainLDO(LATE)
            System->>ASC: synASC(LATE)
            System->>ASN: synASN(LATE)
        end

    else PlannedTime > TSP (Train Late)
        System->>System: Set TrainLDOState = LATE
        System->>LDO: synUpdateTrainLDO(LATE)
        System->>ASC: synASC(TSP, PlannedTime, LATE)

    else TSP Changed to Future Time
        alt PlannedTime <= TSP and TrainLDOState = NOT_LATE
            System->>Timer: Reset timer to new TSP
            Note over System: Keep NOT_LATE status
        end

    else TSP Changed to Past Time
        alt PlannedTime > TSP
            System->>System: Set TrainLDOState = LATE
            System->>LDO: synUpdateTrainLDO(LATE)
            System->>ASC: synASC(TSP, PlannedTime, LATE)
        end
    end
Activity Diagrams
Mermaid Activity Diagram Script
flowchart TD
    Start([Train Entry Trigger]) --> Check{Is Train Eligible?}

    Check -->|No| End([End])
    Check -->|Yes| ActionCheck{Action Code = DELETE?}

    ActionCheck -->|Yes| SetNull[Set TrainLDOState = null]
    SetNull --> End

    ActionCheck -->|No| TimeCompare{PlannedTime vs TSP?}

    TimeCompare -->|PlannedTime ≤ TSP| OnTime[PlannedTime ≤ TSP<br/>Train On Time/Early]
    TimeCompare -->|PlannedTime > TSP| Late[PlannedTime > TSP<br/>Train Late]
    TimeCompare -->|TSP Changed| TSPChange[TSP Changed]

    OnTime --> FutureCheck{TSP in Future?}
    FutureCheck -->|Yes| SetTimer[Set Timer to TSP]
    FutureCheck -->|No| End

    SetTimer --> SetNotLate[Set TrainLDOState = NOT_LATE]
    SetNotLate --> UpdateLDO1[synUpdateTrainLDO NOT_LATE]
    UpdateLDO1 --> UpdateASC1[synASC TSP, PlannedTime, NOT_LATE]
    UpdateASC1 --> WaitTimer[Wait for TSP Timer]

    WaitTimer --> TimerFire{Timer Fires}
    TimerFire --> StillScheduled{Train Still SCHEDULED<br/>and NOT_LATE?}
    StillScheduled -->|Yes| TransitionLate[Set TrainLDOState = LATE]
    StillScheduled -->|No| End

    TransitionLate --> UpdateLDO2[synUpdateTrainLDO LATE]
    UpdateLDO2 --> UpdateASC2[synASC LATE]
    UpdateASC2 --> UpdateASN[synASN LATE]
    UpdateASN --> End

    Late --> PastTSP{TSP in Past OR<br/>Current Time > TSP?}
    PastTSP -->|Yes| SetLateImmediate[Set TrainLDOState = LATE]
    PastTSP -->|No| End

    SetLateImmediate --> UpdateLDO3[synUpdateTrainLDO LATE]
    UpdateLDO3 --> UpdateASC3[synASC TSP, PlannedTime, LATE]
    UpdateASC3 --> End

    TSPChange --> TSPDirection{TSP Changed to?}
    TSPDirection -->|Future Time| FutureTSP{PlannedTime ≤ TSP AND<br/>TrainLDOState = NOT_LATE?}
    TSPDirection -->|Past Time| PastTSPChange{PlannedTime > TSP?}

    FutureTSP -->|Yes| ResetTimer[Reset Timer to New TSP]
    FutureTSP -->|No| End
    ResetTimer --> End

    PastTSPChange -->|Yes| SetLate2[Mark Train as LATE]
    PastTSPChange -->|No| End
    SetLate2 --> End

    style Start fill:#90EE90
    style End fill:#FFB6C1
    style SetNull fill:#FFE4B5
    style TransitionLate fill:#FFA07A
    style SetLateImmediate fill:#FFA07A
    style SetLate2 fill:#FFA07A
API Specifications
OpenAPI 3.0 Specification
openapi: 3.0.0
info:
  title: Active Schedule API
  version: 1.0.0
  description: API for managing train active schedule flow

servers:
  - url: https://api.railway.com/v1
    description: Production server
  - url: https://staging-api.railway.com/v1
    description: Staging server

paths:
  /trains/{trainId}/schedule:
    put:
      summary: Update train schedule information
      operationId: updateTrainSchedule
      tags:
        - Train Schedule
      parameters:
        - name: trainId
          in: path
          required: true
          description: Unique train identifier
          schema:
            type: string
            pattern: '^[A-Z][0-9]{5}$'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TrainScheduleUpdate'
            examples:
              onTimeUpdate:
                summary: On-time train update
                value:
                  trainType: "A"
                  tsp: "2024-01-15T14:30:00Z"
                  plannedTime: "2024-01-15T14:28:00Z"
                  actionCode: "UPDATE"
                  crewCallTime: "2024-01-15T10:30:00Z"
              lateUpdate:
                summary: Late train update
                value:
                  trainType: "B"
                  tsp: "2024-01-15T14:30:00Z"
                  plannedTime: "2024-01-15T14:45:00Z"
                  actionCode: "UPDATE"
                  crewCallTime: "2024-01-15T10:30:00Z"
      responses:
        '200':
          description: Schedule updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Train not found

  /trains/{trainId}/ldo-state:
    put:
      summary: Update train LDO state
      operationId: updateTrainLDOState
      tags:
        - Train LDO
      parameters:
        - name: trainId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LDOStateUpdate'
      responses:
        '200':
          description: LDO state updated successfully
        '400':
          description: Invalid request

  /active-schedule:
    get:
      summary: Get active schedule trains
      operationId: getActiveSchedule
      tags:
        - Active Schedule
      parameters:
        - name: status
          in: query
          description: Filter by train status
          schema:
            type: string
            enum: [LATE, NOT_LATE, ALL]
            default: ALL
        - name: trainType
          in: query
          description: Filter by train type
          schema:
            type: string
        - name: limit
          in: query
          description: Maximum number of records to return
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
      responses:
        '200':
          description: Active schedule retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  trains:
                    type: array
                    items:
                      $ref: '#/components/schemas/TrainScheduleInfo'
                  totalCount:
                    type: integer
                  timestamp:
                    type: string
                    format: date-time

  /system/timer-events:
    post:
      summary: Handle timer events
      operationId: handleTimerEvent
      tags:
        - System Events
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TimerEvent'
      responses:
        '200':
          description: Timer event processed successfully

components:
  schemas:
    TrainScheduleUpdate:
      type: object
      required:
        - trainType
        - actionCode
      properties:
        trainType:
          type: string
          pattern: '^[ABCEGMQSUXZ]'
          description: Train type prefix
        tsp:
          type: string
          format: date-time
          description: Train Scheduled Plan departure time
        plannedTime:
          type: string
          format: date-time
          description: Current estimated departure time
        actionCode:
          type: string
          enum: [DELETE, UPDATE, CREATE]
          description: Action to perform on the train
        crewCallTime:
          type: string
          format: date-time
          description: When crew was called
        trainState:
          type: string
          enum: [SCHEDULED, DEPARTED, CANCELLED]
          default: SCHEDULED

    LDOStateUpdate:
      type: object
      required:
        - trainLDOState
      properties:
        trainLDOState:
          type: string
          enum: [LATE, NOT_LATE]
          nullable: true
          description: Current lateness state
        timestamp:
          type: string
          format: date-time
        reason:
          type: string
          description: Reason for state change

    TrainScheduleInfo:
      type: object
      properties:
        trainId:
          type: string
        trainType:
          type: string
        tsp:
          type: string
          format: date-time
        plannedTime:
          type: string
          format: date-time
        trainLDOState:
          type: string
          enum: [LATE, NOT_LATE]
          nullable: true
        trainState:
          type: string
        crewCallTime:
          type: string
          format: date-time
        timerSetTime:
          type: string
          format: date-time
        lastUpdated:
          type: string
          format: date-time

    TimerEvent:
      type: object
      required:
        - trainId
        - eventType
        - scheduledTime
      properties:
        trainId:
          type: string
        eventType:
          type: string
          enum: [TSP_TIMER_FIRED]
        scheduledTime:
          type: string
          format: date-time
        currentTime:
          type: string
          format: date-time
        trainState:
          type: string
        currentLDOState:
          type: string

    ApiResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        timestamp:
          type: string
          format: date-time

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        timestamp:
          type: string
          format: date-time
        details:
          type: array
          items:
            type: string

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

security:
  - BearerAuth: []
Database Schema
DDL Scripts
-- =====================================================
-- Active Schedule Database Schema
-- =====================================================

-- Main Active Schedule Trains Table
CREATE TABLE ACTIVE_SCHEDULE_TRAINS (
    TRAIN_ID VARCHAR(20) PRIMARY KEY,
    TRAIN_TYPE VARCHAR(10) NOT NULL,
    TSP TIMESTAMP,
    PLANNED_TIME TIMESTAMP,
    TRAIN_LDO_STATE VARCHAR(20),
    TRAIN_STATE VARCHAR(20) DEFAULT 'SCHEDULED',
    ACTION_CODE VARCHAR(20),
    CREW_CALL_TIME TIMESTAMP,
    TIMER_SET_TIME TIMESTAMP,
    IS_TIMER_ACTIVE BIT DEFAULT 0,
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    LAST_UPDATED TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_BY VARCHAR(50) DEFAULT 'SYSTEM',
    
    CONSTRAINT CHK_TRAIN_TYPE CHECK (TRAIN_TYPE LIKE '[ABCEGMQSUXZ]%'),
    CONSTRAINT CHK_LDO_STATE CHECK (TRAIN_LDO_STATE IN ('LATE','NOT_LATE') OR TRAIN_LDO_STATE IS NULL),
    CONSTRAINT CHK_TRAIN_STATE CHECK (TRAIN_STATE IN ('SCHEDULED','DEPARTED','CANCELLED')),
    CONSTRAINT CHK_ACTION_CODE CHECK (ACTION_CODE IN ('CREATE','UPDATE','DELETE'))
);

-- Train Schedule History for Audit Trail
CREATE TABLE TRAIN_SCHEDULE_HISTORY (
    HISTORY_ID BIGINT IDENTITY(1,1) PRIMARY KEY,
    TRAIN_ID VARCHAR(20) NOT NULL,
    OLD_TSP TIMESTAMP,
    NEW_TSP TIMESTAMP,
    OLD_PLANNED_TIME TIMESTAMP,
    NEW_PLANNED_TIME TIMESTAMP,
    OLD_LDO_STATE VARCHAR(20),
    NEW_LDO_STATE VARCHAR(20),
    OLD_TRAIN_STATE VARCHAR(20),
    NEW_TRAIN_STATE VARCHAR(20),
    CHANGE_REASON VARCHAR(100),
    CHANGE_TYPE VARCHAR(50),
    CHANGE_TIMESTAMP TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CHANGED_BY VARCHAR(50) DEFAULT 'SYSTEM',
    
    FOREIGN KEY (TRAIN_ID) REFERENCES ACTIVE_SCHEDULE_TRAINS(TRAIN_ID)
);

-- Timer Events Management
CREATE TABLE TRAIN_TIMER_EVENTS (
    EVENT_ID BIGINT IDENTITY(1,1) PRIMARY KEY,
    TRAIN_ID VARCHAR(20) NOT NULL,
    TIMER_TYPE VARCHAR(20) NOT NULL DEFAULT 'TSP_TIMER',
    SCHEDULED_FIRE_TIME TIMESTAMP NOT NULL,
    ACTUAL_FIRE_TIME TIMESTAMP,
    EVENT_STATUS VARCHAR(20) DEFAULT 'PENDING',
    RETRY_COUNT INT DEFAULT 0,
    ERROR_MESSAGE VARCHAR(500),
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    LAST_UPDATED TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT CHK_TIMER_TYPE CHECK (TIMER_TYPE IN ('TSP_TIMER','CREW_CALL_TIMER')),
    CONSTRAINT CHK_EVENT_STATUS CHECK (EVENT_STATUS IN ('PENDING','FIRED','CANCELLED','ERROR')),
    FOREIGN KEY (TRAIN_ID) REFERENCES ACTIVE_SCHEDULE_TRAINS(TRAIN_ID)
);

-- System Configuration
CREATE TABLE ACTIVE_SCHEDULE_CONFIG (
    CONFIG_KEY VARCHAR(50) PRIMARY KEY,
    CONFIG_VALUE VARCHAR(200) NOT NULL,
    CONFIG_TYPE VARCHAR(20) DEFAULT 'STRING',
    DESCRIPTION VARCHAR(500),
    IS_ACTIVE BIT DEFAULT 1,
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    LAST_UPDATED TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_BY VARCHAR(50) DEFAULT 'SYSTEM'
);

-- API Integration Log
CREATE TABLE API_INTEGRATION_LOG (
    LOG_ID BIGINT IDENTITY(1,1) PRIMARY KEY,
    TRAIN_ID VARCHAR(20),
    API_TYPE VARCHAR(50) NOT NULL,
    ENDPOINT VARCHAR(200),
    REQUEST_PAYLOAD NVARCHAR(MAX),
    RESPONSE_PAYLOAD NVARCHAR(MAX),
    HTTP_STATUS_CODE INT,
    EXECUTION_TIME_MS INT,
    ERROR_MESSAGE VARCHAR(500),
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT CHK_API_TYPE CHECK (API_TYPE IN ('synUpdateTrainLDO','synASC','synASN','TIMER_EVENT'))
);

-- Performance Indexes
CREATE INDEX IX_ACTIVE_SCHEDULE_TSP ON ACTIVE_SCHEDULE_TRAINS(TSP) WHERE TSP IS NOT NULL;
CREATE INDEX IX_ACTIVE_SCHEDULE_STATE ON ACTIVE_SCHEDULE_TRAINS(TRAIN_LDO_STATE) WHERE TRAIN_LDO_STATE IS NOT NULL;
CREATE INDEX IX_ACTIVE_SCHEDULE_TYPE ON ACTIVE_SCHEDULE_TRAINS(TRAIN_TYPE);
CREATE INDEX IX_ACTIVE_SCHEDULE_UPDATED ON ACTIVE_SCHEDULE_TRAINS(LAST_UPDATED);

CREATE INDEX IX_TIMER_EVENTS_FIRE_TIME ON TRAIN_TIMER_EVENTS(SCHEDULED_FIRE_TIME, EVENT_STATUS);
CREATE INDEX IX_TIMER_EVENTS_STATUS ON TRAIN_TIMER_EVENTS(EVENT_STATUS, CREATED_DATE);

CREATE INDEX IX_HISTORY_TRAIN_ID ON TRAIN_SCHEDULE_HISTORY(TRAIN_ID, CHANGE_TIMESTAMP);
CREATE INDEX IX_HISTORY_TIMESTAMP ON TRAIN_SCHEDULE_HISTORY(CHANGE_TIMESTAMP);

CREATE INDEX IX_API_LOG_TIMESTAMP ON API_INTEGRATION_LOG(CREATED_DATE);
CREATE INDEX IX_API_LOG_TRAIN_ID ON API_INTEGRATION_LOG(TRAIN_ID, CREATED_DATE);

-- Insert Default Configuration
INSERT INTO ACTIVE_SCHEDULE_CONFIG (CONFIG_KEY, CONFIG_VALUE, CONFIG_TYPE, DESCRIPTION) VALUES
('CREW_CALL_ADVANCE_HOURS', '4', 'INTEGER', 'Default hours before TSP for crew call requirement'),
('ELIGIBLE_TRAIN_TYPES', 'A,B,C,E,G,M,Q,S,U,X,Z', 'STRING', 'Valid train type prefixes for active schedule'),
('MAX_RETRY_COUNT', '3', 'INTEGER', 'Maximum retry attempts for failed API calls'),
('TIMER_PRECISION_SECONDS', '30', 'INTEGER', 'Timer precision in seconds'),
('API_TIMEOUT_SECONDS', '30', 'INTEGER', 'API call timeout in seconds'),
('LOG_RETENTION_DAYS', '90', 'INTEGER', 'Number of days to retain API integration logs');

-- Sample Data
INSERT INTO ACTIVE_SCHEDULE_TRAINS (TRAIN_ID, TRAIN_TYPE, TSP, PLANNED_TIME, TRAIN_LDO_STATE, CREW_CALL_TIME)
VALUES 
('A12345', 'A', '2024-01-15 14:30:00', '2024-01-15 14:35:00', 'NOT_LATE', '2024-01-15 10:30:00'),
('B67890', 'B', '2024-01-15 15:00:00', '2024-01-15 15:10:00', 'LATE', '2024-01-15 11:00:00'),
('C11111', 'C', '2024-01-15 16:00:00', '2024-01-15 15:55:00', 'NOT_LATE', '2024-01-15 12:00:00');

-- Sample Timer Events
INSERT INTO TRAIN_TIMER_EVENTS (TRAIN_ID, TIMER_TYPE, SCHEDULED_FIRE_TIME, EVENT_STATUS)
VALUES 
('A12345', 'TSP_TIMER', '2024-01-15 14:30:00', 'PENDING'),
('C11111', 'TSP_TIMER', '2024-01-15 16:00:00', 'PENDING');
JSON Payloads
Train Schedule Update Payload
{
  "trainId": "A12345",
  "trainType": "A",
  "tsp": "2024-01-15T14:30:00Z",
  "plannedTime": "2024-01-15T14:35:00Z",
  "actionCode": "UPDATE",
  "trainLDOState": "NOT_LATE",
  "trainState": "SCHEDULED",
  "crewCallTime": "2024-01-15T10:30:00Z",
  "timestamp": "2024-01-15T13:45:00Z"
}
Timer Event Payload
{
  "trainId": "A12345",
  "eventType": "TSP_TIMER_FIRED",
  "scheduledTime": "2024-01-15T14:30:00Z",
  "currentTime": "2024-01-15T14:30:00Z",
  "trainState": "SCHEDULED",
  "currentLDOState": "NOT_LATE"
}
LDO State Update Payload
{
  "trainId": "A12345",
  "trainLDOState": "LATE",
  "timestamp": "2024-01-15T14:30:01Z",
  "reason": "TSP_TIMER_EXPIRED"
}
ASC Service Payload
{
  "trainId": "A12345",
  "tsp": "2024-01-15T14:30:00Z",
  "plannedTime": "2024-01-15T14:35:00Z",
  "trainLDOState": "LATE",
  "changeReason": "TSP_TIMER_EXPIRED",
  "timestamp": "2024-01-15T14:30:01Z"
}
ASN Notification Payload
{
  "trainId": "A12345",
  "notificationType": "TRAIN_LATE",
  "trainLDOState": "LATE",
  "tsp": "2024-01-15T14:30:00Z",
  "plannedTime": "2024-01-15T14:35:00Z",
  "delayMinutes": 5,
  "timestamp": "2024-01-15T14:30:01Z",
  "recipients": ["dispatcher@railway.com", "control@railway.com"]
}
Inbound APIs
{
  "inboundAPIs": [
    {
      "endpoint": "/api/v1/trains/{trainId}/schedule-update",
      "method": "POST",
      "description": "Receive train schedule updates from external systems",
      "payload": "TrainScheduleUpdate"
    },
    {
      "endpoint": "/api/v1/trains/{trainId}/crew-call",
      "method": "POST", 
      "description": "Receive crew call notifications",
      "payload": "CrewCallNotification"
    },
    {
      "endpoint": "/api/v1/system/timer-events",
      "method": "POST",
      "description": "Receive timer expiration events",
      "payload": "TimerEvent"
    }
  ]
}
Outbound APIs
{
  "outboundAPIs": [
    {
      "service": "TrainLDOService",
      "endpoint": "/api/v1/trains/{trainId}/ldo-state",
      "method": "PUT",
      "description": "synUpdateTrainLDO",
      "payload": "LDOStateUpdate"
    },
    {
      "service": "ASCService", 
      "endpoint": "/api/v1/asc/train-status",
      "method": "POST",
      "description": "synASC - Active Schedule Coordinator",
      "payload": "ASCUpdate"
    },
    {
      "service": "ASNService",
      "endpoint": "/api/v1/asn/notifications",
      "method": "POST", 
      "description": "synASN - Active Schedule Notifications",
      "payload": "ASNNotification"
    }
  ]
}
Implementation Guide
System Architecture
Core Components:

Active Schedule System: Main orchestrator
Timer Service: Manages TSP timers
Train LDO Service: Handles late/not-late state updates
ASC Service: Active Schedule Coordinator
ASN Service: Active Schedule Notifications
Service Integration Points
1. synUpdateTrainLDO Service
{
  "endpoint": "PUT /api/v1/trains/{trainId}/ldo-state",
  "description": "Updates train Late/Not-Late state in LDO system",
  "payload": {
    "trainId": "string",
    "trainLDOState": "LATE|NOT_LATE|null",
    "timestamp": "ISO8601",
    "reason": "string"
  },
  "timeout": "30 seconds",
  "retryPolicy": "3 attempts with exponential backoff"
}
2. synASC Service
{
  "endpoint": "POST /api/v1/asc/train-status",
  "description": "Synchronizes with Active Schedule Coordinator",
  "payload": {
    "trainId": "string",
    "tsp": "ISO8601",
    "plannedTime": "ISO8601", 
    "trainLDOState": "LATE|NOT_LATE",
    "changeReason": "string",
    "timestamp": "ISO8601"
  },
  "timeout": "30 seconds",
  "retryPolicy": "3 attempts with exponential backoff"
}
3. synASN Service
{
  "endpoint": "POST /api/v1/asn/notifications",
  "description": "Sends notifications for late trains",
  "payload": {
    "trainId": "string",
    "notificationType": "TRAIN_LATE",
    "trainLDOState": "LATE",
    "tsp": "ISO8601",
    "plannedTime": "ISO8601",
    "delayMinutes": "number",
    "timestamp": "ISO8601"
  },
  "timeout": "30 seconds",
  "retryPolicy": "3 attempts with exponential backoff"
}
Error Handling Strategy
Retry Logic
Maximum 3 retry attempts for API calls
Exponential backoff: 1s, 2s, 4s
Log all retry attempts
Alert operations team after max retries exceeded
Fallback Mechanisms
Database transaction rollback on API failure
Manual intervention workflow for critical failures
Health check endpoints for monitoring
Deployment and Monitoring
Configuration Management
Environment-Specific Settings
{
  "development": {
    "crewCallAdvanceHours": 4,
    "timerPrecisionSeconds": 60,
    "apiTimeoutSeconds": 30,
    "logLevel": "DEBUG"
  },
  "production": {
    "crewCallAdvanceHours": 4,
    "timerPrecisionSeconds": 30,
    "apiTimeoutSeconds": 15,
    "logLevel": "INFO"
  }
}
Monitoring and Alerting
Key Metrics to Monitor
API call success/failure rates
Timer firing accuracy
Database performance
Train state transition frequency
Late notification delivery time
Alert Conditions
API failure rate > 5%
Timer lag > 2 minutes
Database connection failures
Unprocessed train updates > 10
Testing Strategy
Unit Tests
Train eligibility validation
State transition logic
Timer management functions
API payload validation
Integration Tests
End-to-end flow testing
Database transaction testing
External API integration
Timer service integration
Performance Tests
High volume train updates
Concurrent timer processing
Database load testing
API response time validation
Deployment Checklist
Pre-Deployment
Database schema deployed
Configuration values set
API endpoints tested
Timer service configured
Monitoring setup complete
Post-Deployment
Verify active schedule processing
Check timer accuracy
Monitor API call success rates
Validate state transitions
Test notification delivery
Support and Maintenance
Log File Locations
Application logs: /logs/active-schedule/app.log
API integration logs: Database table API_INTEGRATION_LOG
Timer events: Database table TRAIN_TIMER_EVENTS
Error logs: /logs/active-schedule/error.log
Troubleshooting Guide
Train not transitioning to LATE: Check timer service status and TSP value
API calls failing: Verify endpoint connectivity and authentication
Database deadlocks: Review concurrent update patterns
Missing notifications: Check ASN service integration
Maintenance Tasks
Daily: Review error logs and failed API calls
Weekly: Clean up old timer events and logs
Monthly: Analyze performance metrics and optimize
Quarterly: Review and update configuration values
Conversation Summary
This document contains the complete analysis and implementation package for the Active Schedule Flow system based on our conversation. The user requested:

Understanding of the requirements: Explained the core concepts and processing logic
Step-by-step analysis: Broke down the flow into manageable steps
Visual diagrams: Provided Mermaid sequence and activity diagrams
Complete API specifications: OpenAPI 3.0 format with all endpoints
Database schema: Full DDL with tables, indexes, and sample data
JSON payloads: All inbound and outbound API payloads
Implementation guidance: Service integration, error handling, monitoring
All components are designed to work together as a cohesive system for managing train active schedule flow with proper late/not-late state management, timer-based processing, and external system integration.

Generated on: January 24, 2026 This document serves as a comprehensive implementation guide for the Active Schedule Flow system.
